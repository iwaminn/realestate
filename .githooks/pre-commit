#!/bin/bash
# Git pre-commit hook: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒã‚§ãƒƒã‚¯

echo "ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

# models.py ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if git diff --cached --name-only | grep -q "backend/app/models.py"; then
    echo "ğŸ“ models.py ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™"
    
    # check_migrations.py ã‚’å®Ÿè¡Œ
    if [ -f "backend/scripts/check_migrations.py" ]; then
        python backend/scripts/check_migrations.py
        if [ $? -ne 0 ]; then
            echo ""
            echo "âŒ ã‚³ãƒŸãƒƒãƒˆã‚’ä¸­æ­¢ã—ã¾ã—ãŸ"
            echo ""
            echo "models.py ã‚’å¤‰æ›´ã—ãŸå ´åˆã¯ã€å¿…ãšãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„:"
            echo "  1. poetry run alembic revision --autogenerate -m \"å¤‰æ›´ã®èª¬æ˜\""
            echo "  2. poetry run alembic upgrade head"
            echo "  3. ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚³ãƒŸãƒƒãƒˆã«å«ã‚ã‚‹"
            echo ""
            echo "è©³ç´°ã¯ backend/DATABASE_MANAGEMENT.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚"
            exit 1
        fi
    fi
fi

echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"