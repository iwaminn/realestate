# スマートスクレイピング機能ガイド

## 概要

新しいスマートスクレイピング機能により、効率的な物件情報の取得と更新が可能になりました。

## 主な機能

### 1. 詳細ページの選択的取得

- **初回スクレイピング**: 全ての物件の詳細ページを取得
- **2回目以降**: 以下の条件に該当する場合のみ詳細ページを取得
  - 新着・更新マークがある物件
  - 詳細ページを90日以上取得していない物件（設定可能）
  - まだ詳細ページを取得したことがない物件

### 2. データベースへの記録

新しく追加されたカラム:
- `detail_fetched_at`: 詳細ページを最後に取得した日時
- `has_update_mark`: 一覧ページで更新マークが検出されたか
- `detail_info`: 詳細ページから取得した追加情報（JSON形式）
- `list_update_date`: 一覧ページに表示される更新日

### 3. 各スクレイパーの実装状況

#### SUUMO（suumo_scraper_v3.py）
- ✅ 更新マーク検出機能
- ✅ 詳細ページ取得機能
- ✅ 階数・部屋番号の詳細取得
- ✅ 設備情報の取得
- ✅ 物件画像の保存

#### HOMES（homes_scraper.py）
- ✅ 更新マーク検出機能（`scrape_area_v2`メソッド）
- ✅ 詳細ページ取得機能
- ✅ 管理費・修繕積立金の取得
- ✅ 部屋番号・階数の詳細取得
- ✅ 複数画像の取得（最大10枚）
- ✅ 更新日の解析

#### AtHome（athome_scraper_v2.py）
- ✅ 更新マーク検出機能（`scrape_area_v2`メソッド）
- ✅ 詳細ページ取得機能
- ✅ 管理費・修繕積立金の取得

## 設定

### 環境変数での設定

スクレイパーの動作は環境変数で設定可能です：

```bash
# 全スクレイパー共通設定
export SCRAPER_DELAY=2                    # スクレイピング間隔（秒）
export SCRAPER_DETAIL_REFETCH_DAYS=90     # 詳細ページ再取得間隔（日）
export SCRAPER_MAX_PAGES=5                # デフォルトの最大ページ数

# スクレイパー個別設定（例：SUUMO）
export SCRAPER_SUUMO_DELAY=3              # SUUMOのみ3秒間隔
export SCRAPER_SUUMO_DETAIL_REFETCH_DAYS=60  # SUUMOは60日で再取得

# スクレイパー個別設定（例：HOMES）
export SCRAPER_HOMES_DETAIL_REFETCH_DAYS=120  # HOMESは120日で再取得
```

### デフォルト値

環境変数が設定されていない場合のデフォルト値：
- スクレイピング間隔: 2秒
- 詳細ページ再取得間隔: 90日
- 最大ページ数: 5ページ

## 使用方法

### テストスクリプトの実行

```bash
# スマートスクレイピングのテスト
poetry run python backend/scripts/test_smart_scraping.py
```

### 通常のスクレイピング実行

```bash
# SUUMOのみ実行
poetry run python backend/scripts/run_scrapers.py --scraper suumo --pages 3

# 全サイトを実行
poetry run python backend/scripts/run_scrapers.py --scraper all --pages 3
```

## パフォーマンスの改善

### 処理時間の短縮

1. **初回実行**: 従来通り全ての詳細ページを取得
2. **2回目以降**: 
   - 更新のない物件: 詳細ページをスキップ（約90%の時間短縮）
   - 更新のある物件: 詳細ページを再取得

### ネットワーク負荷の軽減

- 不要な詳細ページアクセスを削減
- サーバーへの負荷を最小限に抑制
- レート制限に引っかかるリスクを低減

## 今後の拡張予定

1. **更新日の解析強化**
   - 一覧ページに表示される更新日を解析
   - より正確な更新判定

2. **差分検出**
   - 価格変更の自動検出
   - 掲載終了の早期発見

3. **スケジューリング最適化**
   - 新着物件が多い時間帯に重点的にスクレイピング
   - サイトごとの更新パターンを学習

## トラブルシューティング

### 詳細ページが取得されない場合

1. データベースの`detail_fetched_at`を確認
2. `has_update_mark`の状態を確認
3. 手動で`detail_fetched_at`をNULLにリセットして再実行

### 更新マークが検出されない場合

1. 各サイトのHTML構造が変更されていないか確認
2. セレクタの更新が必要な場合は対応するスクレイパーを修正

## まとめ

このスマートスクレイピング機能により、効率的かつサーバーフレンドリーな物件情報の収集が可能になりました。定期的な実行でも負荷を最小限に抑えながら、最新の情報を維持できます。