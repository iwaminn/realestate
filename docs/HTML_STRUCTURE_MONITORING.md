# HTML構造変更監視システム

## 概要

各不動産サイトのHTML構造変更を早期に検知し、スクレイパーの修正が必要な箇所を特定するシステム。

## 必須監視項目

### SUUMO
1. **価格**
   - 現在のセレクタ: テーブル内の「価格」ラベル
   - 重要度: 最高
   
2. **建物名**
   - 現在のセレクタ: テーブル内の「物件名」ラベル
   - 重要度: 高
   
3. **専有面積**
   - 現在のセレクタ: テーブル内の「専有面積」ラベル
   - 重要度: 高
   
4. **間取り**
   - 現在のセレクタ: テーブル内の「間取り」ラベル
   - 重要度: 高
   
5. **所在階**
   - 現在のセレクタ: テーブル内の「所在階」ラベル
   - 重要度: 中

### LIFULL HOME'S
（同様に記載）

## 検知方法

### 1. 統計ベースの検知
- 各項目の取得成功率を監視
- 急激な低下（例：90%→10%）を検知したらアラート

### 2. サンプリング検知
- 定期的に特定の物件URLで全項目の取得をテスト
- 失敗したらHTML構造を保存して差分を分析

### 3. エラーパターン分析
- 同じ項目で連続してエラーが発生したら構造変更の可能性

## アラート基準

### 即時アラート（重大）
- 価格が50%以上の物件で取得できない
- 新規物件で必須項目が3つ以上取得できない

### 警告アラート
- 特定の項目で20%以上エラー発生
- 既知の物件で新たにエラーが発生

### 情報アラート
- 特定の項目で5%以上エラー発生

## 対応フロー

1. **エラー検知**
   - 自動でHTML構造変更を検知

2. **影響範囲の特定**
   - どの項目が取得できなくなったか
   - 影響を受ける物件数

3. **一時的な対策**
   - 該当スクレイパーの一時停止
   - またはエラー項目のスキップ

4. **恒久対策**
   - スクレイパーのセレクタを修正
   - テストを実施して確認

## 実装案

### 短期対策（実装済み）
重要項目（価格、建物名、専有面積、間取り）の取得エラーが発生した場合：
1. 該当物件の詳細取得を失敗として扱い、データ更新を行わない
2. エラーをキャッシュして24時間は同じエラーログを表示しない
3. エラーが発生した物件は次回スクレイピング時に詳細取得をスキップ

### 中期対策（TODO）

#### 1. HTML構造監視システムの構築
```python
class HtmlStructureMonitor:
    def __init__(self):
        self.required_fields = {
            'suumo': {
                'price': {'selector': 'table th:contains("価格")', 'importance': 'critical'},
                'building_name': {'selector': 'table th:contains("物件名")', 'importance': 'high'},
                'area': {'selector': 'table th:contains("専有面積")', 'importance': 'high'},
                'layout': {'selector': 'table th:contains("間取り")', 'importance': 'high'},
                # ...
            }
        }
        
    def check_field_extraction_rate(self, scraper_stats):
        """各フィールドの取得率をチェック"""
        for field, stats in scraper_stats.items():
            success_rate = stats['success'] / stats['total']
            if success_rate < 0.5 and stats['importance'] == 'critical':
                self.send_critical_alert(field, success_rate)
```

#### 2. エラーレポート機能の拡張
- `backend/app/utils/scraper_error_logger.py` を活用
- HTML構造変更の可能性を自動検出
- 管理画面でのリアルタイム監視ダッシュボード
- Slack/メール通知機能

#### 3. テストスイートの構築
- 各スクレイパーの重要セレクタをテスト
- 定期的なCI/CDでの自動チェック
- モックHTMLを使った回帰テスト

### 長期対策（TODO）

#### 1. 堅牢なセレクタの実装
- CSSセレクタに依存しない複数の取得方法を実装
- テキストマッチング、正規表現、XPathの組み合わせ
- フォールバック機構の実装

#### 2. 機械学習ベースの自動更新
- HTML構造の変更を学習して自動的にセレクタを更新
- 過去の成功パターンから新しいセレクタを推論
- A/Bテストによる新セレクタの検証

#### 3. スクレイパーバージョン管理
- 各サイトのHTML構造バージョンを管理
- バージョンごとのスクレイパー実装
- 自動切り替え機能

## エラー処理フロー（実装済み）

1. **詳細ページ取得時**
   - 重要項目が取得できない → エラーとして処理
   - エラーをキャッシュに記録
   - 物件の更新をスキップ

2. **次回スクレイピング時**
   - キャッシュをチェック
   - エラー履歴がある物件は詳細取得をスキップ
   - 効率的な処理を実現

3. **エラーログ**
   - 24時間以内の重複エラーは表示しない
   - 管理画面で確認可能
   - 統計情報として集計