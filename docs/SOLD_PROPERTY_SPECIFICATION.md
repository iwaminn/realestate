# 販売終了物件の管理仕様

## 概要
このドキュメントは、都心マンションDBシステムにおける販売終了物件の判定、管理、表示に関する仕様を定義します。

## 1. 販売終了の判定基準

### 1.1 掲載終了の判定
- **24時間ルール**: 最後の確認（`last_confirmed_at`）から24時間以上経過した掲載情報は「掲載終了」として扱う
- 掲載終了時の処理:
  - `is_active` を `False` に設定
  - `delisted_at` に最終確認日時を設定

### 1.2 物件の販売終了判定
- すべての掲載情報が非アクティブ（`is_active = False`）になった物件は「販売終了」とする
- 販売終了時の処理:
  - `master_properties.sold_at` に販売終了日を設定
  - `master_properties.last_sale_price` に最終販売価格を記録

## 2. 買い取り再販物件の判定

### 2.1 判定条件
以下のすべての条件を満たす場合、新規物件を「買い取り再販物件」として扱う：

1. **時間条件**: 販売終了から1ヶ月以上経過している
2. **物件の同一性**: 
   - 同じ建物（`building_id`）
   - 同じ階（`floor_number`）
   - 同じ間取り（`layout`）
   - 面積の差が0.5㎡以内
3. **価格条件**: 新規物件の価格が前回の最終販売価格より10%以上高い

### 2.2 再販物件の処理
- 新しい`MasterProperty`レコードを作成（前回の販売履歴を保持）
- `is_resale` フラグを `True` に設定
- `resale_property_id` に前回の物件IDを設定

## 3. データベーススキーマ

### 3.1 MasterPropertyテーブルの追加フィールド
```sql
sold_at         TIMESTAMP    -- 販売終了日（全掲載が終了した日）
last_sale_price INTEGER      -- 最終販売価格（販売終了時の価格）
```

### 3.2 PropertyListingテーブルの関連フィールド
```sql
is_active         BOOLEAN DEFAULT TRUE  -- 掲載中フラグ
last_confirmed_at TIMESTAMP            -- 最終確認日時
delisted_at       TIMESTAMP            -- 掲載終了日時
```

## 4. フロントエンド表示仕様

### 4.1 視覚的な区別
販売終了物件は以下の方法で視覚的に区別する：

1. **透明度**: 60-80%の透明度で薄く表示
2. **バッジ**: 赤色の「掲載終了」バッジを表示
3. **日付表示**: 掲載終了日を表示

### 4.2 表示オプション
- **物件一覧画面**: 「販売終了物件を含む」チェックボックス（デフォルト: オフ）
- **建物ごと物件一覧**: 同様のオプションを提供

## 5. 定期更新スクリプト

### 5.1 update_listing_status.py
以下の処理を定期的に実行：

1. 24時間以上確認されていない掲載を非アクティブ化
2. 全掲載が非アクティブになった物件に販売終了日を設定
3. 最終販売価格を記録

### 5.2 実行タイミング
- 推奨: 1日1回（深夜）の実行
- cronジョブまたはスケジューラーで自動化

## 6. API仕様

### 6.1 物件一覧API
- パラメータ: `include_inactive` (boolean)
  - `true`: 販売終了物件を含む
  - `false`: アクティブな物件のみ（デフォルト）

### 6.2 レスポンスフィールド
```json
{
  "has_active_listing": false,  // アクティブな掲載があるか
  "sold_at": "2024-01-15",      // 販売終了日
  "last_sale_price": 5800,      // 最終販売価格（万円）
  "delisted_at": "2024-01-15"   // 掲載終了日
}
```

## 7. ビジネスロジック

### 7.1 再販物件の価値
買い取り再販物件を別物件として扱うことで：
- 前回の販売履歴を保持
- 価格変動の追跡が可能
- リノベーション前後の比較が可能

### 7.2 統計・分析への活用
- 販売期間の分析
- 価格変動の追跡
- 再販率の計算
- エリア別の売れ行き分析

## 8. 注意事項

1. **データの整合性**: 販売終了日は必ず最後の掲載終了日以降になる
2. **パフォーマンス**: 大量の販売終了物件がある場合、適切なインデックスが必要
3. **プライバシー**: 個人情報を含む可能性があるため、適切なアクセス制御が必要