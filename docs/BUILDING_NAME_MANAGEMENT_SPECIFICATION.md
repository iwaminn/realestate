# 建物名管理システム仕様書

## 概要

本システムは、複数の不動産情報サイトから収集した建物名を統一的に管理し、多数決により最適な建物名を決定する仕組みを提供します。

## 基本方針

1. **元の建物名の保持**
   - スクレイパーで取得した建物名は、正規化せずにそのまま保存
   - 各サイトの表記をBuildingAliasテーブルに記録

2. **2段階の処理**
   - **検索・統合用**: 最小限の正規化で同一建物を判定
   - **表示用**: 多数決により最適な建物名を選択

3. **学習する仕組み**
   - エイリアスが増えるほど建物名の精度が向上
   - 表記ゆれのパターンを蓄積

## データベース構造

### buildingsテーブル
- `id`: 建物ID
- `normalized_name`: 表示用の建物名（多数決で決定）
- `address`: 住所
- その他の建物属性

### building_aliasesテーブル
- `building_id`: 建物ID
- `alias_name`: 元の建物名（正規化前）
- `source`: 情報源（SUUMO、HOMES等）
- `created_at`: 作成日時

## 処理フロー

### 1. 建物の新規登録・検索

```python
# base_scraper.py の get_or_create_building メソッド

1. 元の建物名を保存
2. 検索キーを生成（最小限の正規化）
   - 全角英数字→半角
   - スペース・記号の除去
   - 大文字統一
   - 末尾の棟表記を除去（検索時のみ）
3. 既存建物を検索
4. 見つからない場合は新規作成（元の名前を使用）
5. BuildingAliasに元の名前を記録
```

### 2. 建物名の多数決更新

```python
# majority_vote_updater.py の update_building_name_by_majority メソッド

1. BuildingAliasから全ての名前を取得
2. 重み付け投票
   - 基本の重み: 出現回数
   - サイト優先度による重み付け
   - 広告文は重みを減少（0.1倍）
3. 最も重みの高い名前を選択
4. 建物名を更新
```

## 検索キー生成ロジック

```python
def get_search_key_for_building(building_name: str) -> str:
    # 全角英数字→半角
    key = jaconv.z2h(building_name, kana=False, ascii=True, digit=True)
    # スペースと記号の正規化
    key = re.sub(r'[\s　・－―～〜]+', '', key)
    # 大文字統一
    key = key.upper()
    # 末尾の棟表記を除去（検索時のみ）
    key = re.sub(r'(EAST|WEST|NORTH|SOUTH|E|W|N|S|東|西|南|北)?棟$', '', key)
    return key
```

### 例
- `白金ザ・スカイＥＡＳＴ棟` → `白金ザスカイ`
- `白金ザ・スカイ E棟` → `白金ザスカイ`
- `白金ザ・スカイ` → `白金ザスカイ`

## サイト優先順位

1. SUUMO（最高優先度）
2. HOMES
3. 三井のリハウス
4. ノムコム
5. 東急リバブル

## 掲載状態を考慮した多数決ロジック（2025年1月実装）

建物名の多数決では、掲載情報の鮮度を考慮します：

### アクティブな掲載がある場合
- 24時間以内に確認された掲載情報（`is_active = True`）がある場合
- アクティブな掲載情報からのエイリアスのみを使用して多数決
- 非アクティブな掲載の情報は古い可能性があるため除外

### 全ての掲載が非アクティブの場合
- 全ての掲載が24時間以上確認されていない場合
- 販売終了日（`sold_at`）から1週間以内の掲載情報を使用
- 1週間以内の情報がない場合は、全てのエイリアスを使用（従来の動作）

この仕組みにより、常に最新の情報を優先して建物名を決定します。

## 広告文の判定

以下のパターンを含む場合は広告文と判定し、重みを大幅に減少させます：

- 徒歩○分
- 駅名○分
- の中古マンション
- 新築、分譲、賃貸
- 価格情報（○万円）
- 間取り情報（○LDK）
- 階数情報（○階建）
- 築年情報（築○年）
- 3文字未満の短い名前

## 運用

### リアルタイム更新（2025年1月実装）

建物名は以下のタイミングで自動的に多数決により更新されます：

1. **物件登録・更新時**
   - スクレイパーが新しい掲載情報を登録または更新した際
   - `base_scraper.py`の`create_or_update_listing`メソッドで自動実行

2. **新しいエイリアス追加時**
   - スクレイパーが新しい建物名のバリエーションを発見した際
   - `base_scraper.py`の`_add_building_alias`メソッドで自動実行

3. **物件統合時**
   - 管理画面で物件重複管理機能を使用して物件を統合した際
   - 統合により掲載情報が移動し、建物に紐づく情報が変わるため

4. **建物統合時**
   - 管理画面で建物重複管理機能を使用して建物を統合した際
   - 複数の建物の情報が統合されるため

5. **物件統合の取り消し時**
   - 管理画面で物件統合を取り消して復元した際
   - 掲載情報が元の物件に戻り、両方の建物の情報が変わるため

6. **建物統合の取り消し時**
   - 管理画面で建物統合を取り消して復元した際
   - 建物が分離され、エイリアスが再配分されるため

### 手動更新（バッチ処理）

リアルタイム更新に加えて、必要に応じて手動でバッチ更新も可能です：

```bash
# 全建物の名前を多数決で更新
docker exec realestate-backend poetry run python /app/backend/scripts/update_building_names_by_majority.py

# 特定の建物のみ更新
docker exec realestate-backend poetry run python /app/backend/scripts/update_building_names_by_majority.py --building-id 123
```

### 重複建物の検出・統合

```bash
# 重複建物を検出
docker exec realestate-backend poetry run python /app/backend/scripts/find_and_merge_duplicate_buildings.py
```

## メリット

1. **柔軟性**: 各サイトの表記を尊重しつつ、統一的な管理が可能
2. **透明性**: なぜその建物名になったかが追跡可能
3. **学習効果**: データが増えるほど精度が向上
4. **保守性**: ロジックの変更が容易

## 注意事項

1. **初期データ**: 新規建物は最初に登録された名前が使用される
2. **更新頻度**: 建物名の更新は負荷を考慮して適切な頻度で実行
3. **手動修正**: 必要に応じて管理画面から手動修正も可能