# 重要仕様書 - マンション一括検索システム

このドキュメントは、システムの重要かつ複雑な仕様をまとめたものです。
仕様変更時は必ずこのドキュメントを更新してください。

最終更新日: 2025-01-25

## 目次

1. [建物名管理システム](#建物名管理システム)
2. [物件ハッシュ生成ルール](#物件ハッシュ生成ルール)
3. [スマートスクレイピング](#スマートスクレイピング)
4. [多数決システム](#多数決システム)
5. [リアルタイム更新トリガー](#リアルタイム更新トリガー)
6. [掲載状態管理](#掲載状態管理)

---

## 建物名管理システム

### 基本方針

1. **元の建物名を保持**
   - スクレイパーで取得した建物名は正規化せずにそのまま保存
   - `buildings.normalized_name`に保存（実際は正規化されていない元の名前）
   - `building_aliases`テーブルに全ての表記バリエーションを記録

2. **2段階の処理**
   - **検索・統合用**: 最小限の正規化で同一建物を判定
   - **表示用**: 多数決により最適な建物名を選択

3. **学習する仕組み**
   - エイリアスが増えるほど建物名の精度が向上
   - 表記ゆれのパターンを蓄積

### 検索キー生成ロジック

```python
def get_search_key_for_building(building_name: str) -> str:
    # 1. 全角英数字→半角
    key = jaconv.z2h(building_name, kana=False, ascii=True, digit=True)
    # 2. スペースと記号の正規化
    key = re.sub(r'[\s　・－―～〜]+', '', key)
    # 3. 大文字統一
    key = key.upper()
    # 4. 末尾の棟表記を除去（検索時のみ）
    key = re.sub(r'(EAST|WEST|NORTH|SOUTH|E|W|N|S|東|西|南|北)?棟$', '', key)
    return key
```

### 例
- `白金ザ・スカイＥＡＳＴ棟` → `白金ザスカイ`
- `白金ザ・スカイ E棟` → `白金ザスカイ`
- `白金ザ・スカイ` → `白金ザスカイ`

---

## 物件ハッシュ生成ルール

### ハッシュ生成式
```
property_hash = hash(建物ID + 所在階 + 平米数 + 間取り + 方角)
```

### 重要な変更（2025年1月）
- **部屋番号はハッシュ生成に使用しません**
- 理由：サイトによって部屋番号の公開状況が異なるため
- LIFULL HOME'Sでは部屋番号が公開されていることがありますが、ハッシュには含めません

### 注意事項
- 方角も含めてハッシュを生成
- 方角だけが異なる場合は別物件として扱われる
- 同一物件で方角情報の有無が異なる場合は、管理画面で手動統合が必要

---

## スマートスクレイピング

### 価格変更ベースの詳細取得（2025年1月実装）

詳細ページの取得条件：
1. **強制取得モード**の場合
2. **新規物件**の場合
3. **価格が変更**されている場合
4. **最終取得から指定日数経過**している場合（デフォルト90日）

### 環境変数設定
```bash
# 全スクレイパー共通
export SCRAPER_DETAIL_REFETCH_DAYS=90

# スクレイパー個別設定（優先）
export SCRAPER_SUUMO_DETAIL_REFETCH_DAYS=60
export SCRAPER_HOMES_DETAIL_REFETCH_DAYS=90

# スマートスクレイピングの有効/無効
export SCRAPER_SMART_SCRAPING=true
export SCRAPER_SUUMO_SMART_SCRAPING=false
```

---

## 多数決システム

### 建物名の多数決（重み付け投票）

#### 基本の重み計算
1. **出現回数**: 基本の重み
2. **サイト優先度**: 
   - SUUMO: 5倍
   - HOMES: 4倍
   - 三井のリハウス: 3倍
   - ノムコム: 2倍
   - 東急リバブル: 1倍
3. **広告文ペナルティ**: 0.1倍

#### 掲載状態を考慮した多数決（2025年1月実装）

**アクティブな掲載がある場合**：
- 24時間以内に確認された掲載情報（`is_active = True`）がある
- アクティブな掲載情報からのエイリアスのみを使用
- 非アクティブな掲載の情報は古い可能性があるため除外

**全ての掲載が非アクティブの場合**：
- 販売終了日（`sold_at`）から1週間以内の掲載情報を優先
- 1週間以内の情報がない場合は、全てのエイリアスを使用

### 物件付属情報の多数決（2025年1月実装）

物件の付属情報（交通、管理費、修繕積立金など）も掲載状態を考慮した多数決で決定：

#### 対象となる情報

**物件レベルの情報（master_propertiesテーブル）**：
- **階数** (`floor_number`): 所在階
- **専有面積** (`area`): 専有面積（㎡）
- **バルコニー面積** (`balcony_area`): バルコニー面積（㎡）
- **間取り** (`layout`): 部屋の間取り（例：3LDK）
- **方角** (`direction`): バルコニーの向き（例：南東）
- **管理費** (`management_fee`): 月額管理費（円）
- **修繕積立金** (`repair_fund`): 月額修繕積立金（円）
- **交通情報** (`station_info`): 駅からの距離、路線情報

**建物レベルの情報（buildingsテーブル）**：
- **住所** (`address`): 建物の所在地
- **総階数** (`total_floors`): 建物の総階数
- **築年** (`built_year`): 建物の竣工年
- **構造** (`structure`): 建物構造（例：RC造）
- **建物名** (`normalized_name`): 表示用の建物名（重み付け投票）

#### 価格情報の特別処理
- **価格は範囲表示**: 多数決ではなく、最小値〜最大値の範囲で表示
- アクティブな掲載の価格のみを集計
- 販売終了物件は `last_sale_price` を使用

#### 多数決の処理フロー
1. アクティブな掲載があるかチェック
2. アクティブな掲載がある場合：アクティブな掲載の情報のみを使用
3. 全て非アクティブの場合：販売終了から1週間以内の掲載情報を使用
4. サイト優先順位を考慮して最頻値を決定

### 広告文の判定パターン
- 徒歩○分
- 駅名○分
- の中古マンション
- 新築、分譲、賃貸
- 価格情報（○万円）
- 間取り情報（○LDK）
- 階数情報（○階建）
- 築年情報（築○年）
- 3文字未満の短い名前

---

## リアルタイム更新トリガー

建物名は以下のタイミングで自動的に多数決により更新されます：

### 1. 物件登録・更新時
- スクレイパーが新しい掲載情報を登録または更新
- `base_scraper.py`の`create_or_update_listing`メソッドで自動実行

### 2. 新しいエイリアス追加時
- スクレイパーが新しい建物名のバリエーションを発見
- `base_scraper.py`の`_add_building_alias`メソッドで自動実行

### 3. 物件統合時
- 管理画面で物件重複管理機能を使用して物件を統合
- `/api/admin/merge-properties`エンドポイント

### 4. 建物統合時
- 管理画面で建物重複管理機能を使用して建物を統合
- 建物統合処理内で自動実行

### 5. 物件統合の取り消し時
- 管理画面で物件統合を取り消して復元
- `/api/admin/revert-property-merge`エンドポイント

### 6. 建物統合の取り消し時
- 管理画面で建物統合を取り消して復元
- `/api/admin/revert-merge`エンドポイント

### 7. 掲載状態の更新時
- 掲載状態（アクティブ/非アクティブ）が変更
- `/api/admin/update-listing-status`エンドポイント

---

## 掲載状態管理

### アクティブ/非アクティブの判定
- **アクティブ**: 24時間以内に掲載が確認されている（`is_active = True`）
- **非アクティブ**: 24時間以上掲載が確認されていない（`is_active = False`）

### 掲載状態の自動更新
- スクレイパー実行時に自動更新
- 掲載が確認できた場合：`is_active = True`、`last_confirmed_at = 現在時刻`
- 掲載が確認できない場合：変更なし（別プロセスで非アクティブ化）

### 販売終了の判定
- 全ての掲載が非アクティブになった場合
- `master_properties.sold_at`に販売終了日時を記録

---

## 実装ファイル一覧

### コアロジック
- `/backend/app/scrapers/base_scraper.py`: 建物検索・作成、エイリアス管理
- `/backend/app/utils/majority_vote_updater.py`: 多数決ロジック
- `/backend/app/utils/property_hasher.py`: 物件ハッシュ生成
- `/backend/app/utils/building_normalizer.py`: 建物名正規化（部分的に使用）

### API/管理画面
- `/backend/app/api/admin.py`: 物件・建物統合、掲載状態更新
- `/backend/app/main.py`: 建物統合取り消し

### スクリプト
- `/backend/scripts/find_and_merge_duplicate_buildings.py`: 重複建物検出・統合
- `/backend/scripts/update_building_names_by_majority.py`: バッチ更新

### ドキュメント
- `/docs/BUILDING_NAME_MANAGEMENT_SPECIFICATION.md`: 建物名管理システム仕様
- `/docs/CRITICAL_SPECIFICATIONS.md`: 本ドキュメント
- `/CLAUDE.md`: プロジェクト全体の概要

---

## 今後の改善案

1. **建物名の手動修正機能**
   - 管理画面から建物名を手動で修正できる機能
   - 修正履歴の記録

2. **エイリアスの重み付け設定**
   - サイトごとの優先度をカスタマイズ可能に
   - 特定のエイリアスを除外する機能

3. **建物名の変更履歴**
   - 建物名がいつ、どのように変更されたかの履歴
   - 変更理由の記録

4. **より高度な広告文判定**
   - 機械学習による広告文の判定
   - カスタムルールの追加

---

## データベース変更

### master_propertiesテーブルの新カラム（2025年1月追加）
```sql
ALTER TABLE master_properties 
ADD COLUMN management_fee INTEGER,      -- 管理費（月額・円）- 多数決で決定
ADD COLUMN repair_fund INTEGER,         -- 修繕積立金（月額・円）- 多数決で決定  
ADD COLUMN station_info TEXT;           -- 交通情報 - 多数決で決定
```

### マイグレーション手順
1. `backend/scripts/add_majority_vote_columns.py` を実行
2. 既存データの更新を選択（y/n）
3. 全物件の情報が多数決で更新される

---

## パフォーマンス最適化（2025年1月実装）

### canonical_nameカラムの追加
建物検索のパフォーマンスを大幅に改善するため、buildingsテーブルに`canonical_name`カラムを追加：

- **目的**: 検索キーを事前計算して保存し、インデックスを活用
- **効果**: 建物検索時に毎回正規化処理を行う必要がなくなり、検索速度が向上
- **実装**: 
  - 新規建物作成時に自動的に設定
  - 既存データはマイグレーションスクリプトで一括更新

### occurrence_countカラムの追加
エイリアスの重み計算を高速化するため、building_aliasesテーブルに`occurrence_count`カラムを追加：

- **目的**: エイリアスの出現回数を記録し、毎回カウントする必要をなくす
- **効果**: 多数決計算時のパフォーマンスが向上
- **実装**:
  - 同じエイリアスが追加されるたびにカウントアップ
  - 既存データはマイグレーションスクリプトで集計

---

## 変更履歴

### 2025-01-25
- 初版作成
- 建物名管理システム、物件ハッシュ、スマートスクレイピング、多数決システムの仕様を整理
- 掲載状態を考慮した多数決ロジックを追加
- 物件付属情報の多数決システムを追加（全ての物件・建物属性を網羅）
  - 物件レベル：階数、専有面積、バルコニー面積、間取り、方角、管理費、修繕積立金、交通情報
  - 建物レベル：住所、総階数、築年、構造、建物名
- 価格の範囲表示機能を追加
- パフォーマンス最適化を実装
  - canonical_nameカラムの追加（建物検索の高速化）
  - occurrence_countカラムの追加（多数決計算の高速化）